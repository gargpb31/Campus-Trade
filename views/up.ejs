<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Profile - Campus Trade</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/styles.css" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="container">
        <div class="header-content">
          <a href="/" class="logo">
            <i class="fas fa-store"></i>
            Campus Trade
          </a>

          <nav>
            <ul class="nav-menu">
              <li><a href="/pro" class="nav-link">Browse Products</a></li>
              <li><a href="/create" class="nav-link">Add Product</a></li>
              <li><a href="/" class="nav-link btn btn-outline">Sign Out</a></li>
            </ul>
          </nav>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <div class="container">
        <div class="profile-container">
          <!-- Profile Header -->
          <div class="profile-header">
            <div class="profile-avatar">
              <% if (userProfile.profile_photo) { %>
              <img src="<%= userProfile.profile_photo %>" alt="Profile Photo" />
              <% } else { %>
              <div class="avatar-placeholder">
                <i class="fas fa-user"></i>
              </div>
              <% } %>
            </div>
            <div class="profile-info">
              <h1><%= userProfile.name || 'Your Name' %></h1>
              <p class="profile-email"><%= userProfile.email %></p>
              <div class="profile-stats">
                <div class="stat-item">
                  <span class="stat-number" id="productsListed">0</span>
                  <span class="stat-label">Products Listed</span>
                </div>
                <div class="stat-item">
                  <span class="stat-number" id="productsSold">0</span>
                  <span class="stat-label">Products Sold</span>
                </div>
                <div class="stat-item">
                  <span class="stat-number" id="reviews">0</span>
                  <span class="stat-label">Reviews</span>
                </div>
              </div>
            </div>
            <div class="profile-actions">
              <a href="/edit-profile" class="btn btn-primary">
                <i class="fas fa-edit"></i> Edit Profile
              </a>
            </div>
          </div>

          <!-- Profile Content -->
          <div class="profile-content">
            <div class="profile-section">
              <h2><i class="fas fa-user"></i> Personal Information</h2>
              <div class="info-grid">
                <div class="info-item">
                  <label>Full Name</label>
                  <span><%= userProfile.name || 'Not set' %></span>
                </div>
                <div class="info-item">
                  <label>Email Address</label>
                  <span><%= userProfile.email %></span>
                </div>
                <div class="info-item">
                  <label>Enrollment Number</label>
                  <span><%= userProfile.enroll_no || 'Not set' %></span>
                </div>
                <div class="info-item">
                  <label>Contact Number</label>
                  <span><%= userProfile.contact || 'Not set' %></span>
                </div>
                <div class="info-item">
                  <label>Room Number</label>
                  <span><%= userProfile.room_no || 'Not set' %></span>
                </div>
                <div class="info-item">
                  <label>Account Type</label>
                  <span class="badge badge-primary"
                    ><%= userProfile.role || 'Student' %></span
                  >
                </div>
              </div>
            </div>

            <!-- My Products Section -->
            <div class="profile-section">
              <div class="section-header">
                <h2><i class="fas fa-box"></i> My Products</h2>
                <a href="/create" class="btn btn-primary btn-sm">
                  <i class="fas fa-plus"></i> Add New Product
                </a>
              </div>

              <div class="products-grid" id="userProducts">
                <!-- Products will be loaded here -->
                <div class="no-products">
                  <i class="fas fa-box-open"></i>
                  <h3>No Products Listed</h3>
                  <p>Start selling by listing your first product</p>
                  <a href="/create" class="btn btn-primary">
                    <i class="fas fa-plus"></i> List Your First Product
                  </a>
                </div>
              </div>
            </div>

            <!-- Account Settings -->
            <div class="profile-section">
              <h2><i class="fas fa-cog"></i> Account Settings</h2>
              <div class="settings-grid">
                <div class="setting-item">
                  <div class="setting-info">
                    <h4>Change Password</h4>
                    <p>Update your account password</p>
                  </div>
                  <button
                    class="btn btn-outline"
                    onclick="showChangePassword()"
                  >
                    <i class="fas fa-key"></i> Change
                  </button>
                </div>
                <div class="setting-item">
                  <div class="setting-info">
                    <h4>Notification Settings</h4>
                    <p>Manage your notification preferences</p>
                  </div>
                  <button class="btn btn-outline">
                    <i class="fas fa-bell"></i> Configure
                  </button>
                </div>
                <div class="setting-item">
                  <div class="setting-info">
                    <h4>Privacy Settings</h4>
                    <p>Control your privacy and visibility</p>
                  </div>
                  <button class="btn btn-outline">
                    <i class="fas fa-shield-alt"></i> Manage
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Change Password Modal -->
    <div id="passwordModal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Change Password</h3>
          <button class="modal-close" onclick="closeModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="changePasswordForm">
          <div class="form-group">
            <label for="currentPassword" class="form-label"
              >Current Password</label
            >
            <input
              type="password"
              id="currentPassword"
              class="form-control"
              required
            />
          </div>
          <div class="form-group">
            <label for="newPassword" class="form-label">New Password</label>
            <input
              type="password"
              id="newPassword"
              class="form-control"
              required
            />
          </div>
          <div class="form-group">
            <label for="confirmNewPassword" class="form-label"
              >Confirm New Password</label
            >
            <input
              type="password"
              id="confirmNewPassword"
              class="form-control"
              required
            />
          </div>
          <div class="modal-actions">
            <button
              type="button"
              class="btn btn-outline"
              onclick="closeModal()"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">
              Update Password
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <h3>Campus Trade</h3>
            <p>Your trusted marketplace for campus commerce.</p>
          </div>
          <div class="footer-section">
            <h3>Quick Links</h3>
            <a href="/pro">Browse Products</a>
            <a href="/create">Add Product</a>
            <a href="/features">Features</a>
          </div>
          <div class="footer-section">
            <h3>Contact</h3>
            <p>Email: support@campustrade.com</p>
            <p>Phone: +91 1234567890</p>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2024 Campus Trade. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <style>
      .profile-container {
        max-width: 1000px;
        margin: 0 auto;
      }

      .profile-header {
        background: var(--bg-primary);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-lg);
        padding: 3rem;
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 2rem;
      }

      .profile-avatar {
        flex-shrink: 0;
        width: 120px;
        height: 120px;
        border-radius: 50%;
        overflow: hidden;
        border: 4px solid var(--primary-color);
        box-shadow: var(--shadow-lg);
      }

      .profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .avatar-placeholder {
        width: 100%;
        height: 100%;
        background: var(--bg-tertiary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-light);
        font-size: 3rem;
      }

      .profile-info {
        flex: 1;
      }

      .profile-info h1 {
        color: var(--text-primary);
        margin-bottom: 0.5rem;
      }

      .profile-email {
        color: var(--text-secondary);
        font-size: 1.125rem;
        margin-bottom: 1.5rem;
      }

      .profile-stats {
        display: flex;
        gap: 2rem;
      }

      .stat-item {
        text-align: center;
      }

      .stat-number {
        display: block;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
      }

      .stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
      }

      .profile-actions {
        flex-shrink: 0;
      }

      .profile-content {
        display: grid;
        gap: 2rem;
      }

      .profile-section {
        background: var(--bg-primary);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        padding: 2rem;
      }

      .profile-section h2 {
        color: var(--text-primary);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .profile-section h2 i {
        color: var(--primary-color);
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .section-header h2 {
        margin-bottom: 0;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
      }

      .info-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .info-item label {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.875rem;
      }

      .info-item span {
        color: var(--text-primary);
        font-size: 1rem;
      }

      .no-products {
        text-align: center;
        padding: 3rem;
        color: var(--text-secondary);
      }

      .no-products i {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: var(--text-light);
      }

      .no-products h3 {
        margin-bottom: 0.5rem;
        color: var(--text-primary);
      }

      .no-products p {
        margin-bottom: 1.5rem;
      }

      .settings-grid {
        display: grid;
        gap: 1rem;
      }

      .setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-color);
      }

      .setting-info h4 {
        color: var(--text-primary);
        margin-bottom: 0.25rem;
      }

      .setting-info p {
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin: 0;
      }

      /* Modal Styles */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal-content {
        background: var(--bg-primary);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-xl);
        padding: 2rem;
        max-width: 500px;
        width: 90%;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .modal-header h3 {
        color: var(--text-primary);
        margin: 0;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--text-light);
        cursor: pointer;
        padding: 0.25rem;
      }

      .modal-close:hover {
        color: var(--text-secondary);
      }

      .modal-actions {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
      }

      @media (max-width: 768px) {
        .profile-header {
          flex-direction: column;
          text-align: center;
          padding: 2rem;
        }

        .profile-stats {
          justify-content: center;
        }

        .section-header {
          flex-direction: column;
          gap: 1rem;
          align-items: flex-start;
        }

        .setting-item {
          flex-direction: column;
          gap: 1rem;
          text-align: center;
        }
      }
    </style>

    <script>
      // Load user stats
      async function loadUserStats() {
        try {
          const response = await fetch("/api/user-stats");
          const stats = await response.json();

          document.getElementById("productsListed").textContent =
            stats.productsListed;
          document.getElementById("productsSold").textContent =
            stats.productsSold;
          document.getElementById("reviews").textContent = stats.reviews;
        } catch (error) {
          console.error("Error loading user stats:", error);
        }
      }

      // Load user products
      async function loadUserProducts() {
        try {
          const response = await fetch("/api/user-products");
          const products = await response.json();

          const productsGrid = document.getElementById("userProducts");

          if (products.length === 0) {
            productsGrid.innerHTML = `
                        <div class="no-products">
                            <i class="fas fa-box-open"></i>
                            <h3>No Products Listed</h3>
                            <p>Start selling by listing your first product</p>
                            <a href="/create" class="btn btn-primary">
                                <i class="fas fa-plus"></i> List Your First Product
                            </a>
                        </div>
                    `;
          } else {
            productsGrid.innerHTML = products
              .map(
                (product) => `
                        <div class="card product-card">
                            <div class="product-image-container">
                                <img src="${product.image_url}" alt="${product.title}" class="product-image">
                            </div>
                            <div class="product-content">
                                <h3 class="product-title">${product.title}</h3>
                                <p class="product-description">${product.content}</p>
                                <div class="product-price">â‚¹${product.expected_amount}</div>
                                <div class="product-actions">
                                    <a href="/edit/${product.id}" class="btn btn-outline btn-sm">
                                        <i class="fas fa-edit"></i> Edit
                                    </a>
                                    <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.id})">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `
              )
              .join("");
          }
        } catch (error) {
          console.error("Error loading user products:", error);
        }
      }

      // Modal functions
      function showChangePassword() {
        document.getElementById("passwordModal").style.display = "flex";
      }

      function closeModal() {
        document.getElementById("passwordModal").style.display = "none";
      }

      // Close modal when clicking outside
      document
        .getElementById("passwordModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            closeModal();
          }
        });

      // Change password form
      document
        .getElementById("changePasswordForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const currentPassword =
            document.getElementById("currentPassword").value;
          const newPassword = document.getElementById("newPassword").value;
          const confirmPassword =
            document.getElementById("confirmNewPassword").value;

          if (newPassword !== confirmPassword) {
            alert("New passwords do not match");
            return;
          }

          if (newPassword.length < 8) {
            alert("Password must be at least 8 characters long");
            return;
          }

          // Here you would typically make an API call to change the password
          alert("Password changed successfully!");
          closeModal();
          this.reset();
        });

      // Delete product function
      function deleteProduct(productId) {
        if (confirm("Are you sure you want to delete this product?")) {
          fetch(`/delete/${productId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((response) => {
              if (response.ok) {
                loadUserProducts();
              } else {
                alert("Error deleting product");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("Error deleting product");
            });
        }
      }

      // Load user products on page load
      document.addEventListener("DOMContentLoaded", function () {
        loadUserStats();
        loadUserProducts();
      });
    </script>
  </body>
</html>
